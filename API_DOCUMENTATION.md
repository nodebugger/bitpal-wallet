# Bitpal Wallet Service API Documentation

## Overview

Bitpal Wallet Service is a backend wallet API that allows users to:
- Sign in using Google OAuth
- Deposit money using Paystack
- View wallet balance and transaction history
- Transfer funds to other users
- Generate API keys for service-to-service access

## Base URL

```
http://localhost:8000/api/v1
```

## Authentication

The API supports two authentication methods:

### 1. JWT Token (User Authentication)
- Obtained via Google OAuth sign-in
- Used in `Authorization` header: `Bearer <token>`
- JWT users can perform all wallet actions

### 2. API Key (Service-to-Service)
- Generated by authenticated users
- Used in `x-api-key` header
- Must have specific permissions
- Maximum 5 active keys per user
- Keys expire and can be revoked

---

## Endpoints

### Authentication

#### GET /auth/google
Initiates Google OAuth sign-in flow.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| redirect | bool | false | If true, redirects to Google. If false, returns JSON with URL. |

**Response (redirect=false):**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Google OAuth URL generated",
    "data": {
        "google_auth_url": "https://accounts.google.com/o/oauth2/v2/auth?..."
    }
}
```

---

#### GET /auth/google/callback
OAuth callback - called by Google after user consent.

**Query Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| code | string | Yes | Authorization code from Google |

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Authentication successful",
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
        "token_type": "bearer",
        "user": {
            "id": "uuid",
            "email": "user@example.com",
            "name": "John Doe",
            "wallet_number": "1234567890123"
        }
    }
}
```

---

### API Key Management

#### POST /keys/create
Create a new API key.

**Authentication:** JWT only

**Request Body:**
```json
{
    "name": "wallet-service",
    "permissions": ["deposit", "transfer", "read"],
    "expiry": "1D"
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | string | Yes | Descriptive name for the key |
| permissions | array | Yes | Array of: "deposit", "transfer", "read" |
| expiry | string | Yes | One of: "1H", "1D", "1M", "1Y" |

**Response:**
```json
{
    "status_code": 201,
    "status": "success",
    "message": "API key created successfully",
    "data": {
        "api_key": "sk_live_xxxxx",
        "expires_at": "2025-01-01T12:00:00Z"
    }
}
```

⚠️ **Important:** The API key is only shown once. Store it securely!

---

#### POST /keys/rollover
Create a new API key from an expired key's permissions. Useful when a key expires but you want to maintain the same permissions.

**Authentication:** JWT only

**Request Body:**
```json
{
    "expired_key_id": "FGH2485K6KK79GKG9GKGK",
    "expiry": "1M"
}
```

**Response:**
```json
{
    "status_code": 201,
    "status": "success",
    "message": "API key rolled over successfully",
    "data": {
        "api_key": "sk_live_yyyyy",
        "expires_at": "2025-02-01T12:00:00Z"
    }
}
```

**Requirements:**
- Source key must exist and be expired (or soon-to-expire)
- You must still be under 5 active keys limit
- The old key is NOT automatically revoked (use DELETE to revoke if needed)

---

#### GET /keys/list
List all API keys for the authenticated user. Automatically marks expired keys as inactive.

**Authentication:** JWT only

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| limit | int | 50 | Maximum keys to return |
| offset | int | 0 | Pagination offset |

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "API keys retrieved",
    "data": {
        "keys": [
            {
                "id": "uuid",
                "name": "wallet-service",
                "key_prefix": "sk_live_xxxxx",
                "permissions": ["deposit", "transfer", "read"],
                "expires_at": "2025-01-01T12:00:00Z",
                "is_active": true,
                "is_revoked": false,
                "is_expired": false,
                "created_at": "2024-12-01T10:00:00Z",
                "last_used_at": "2024-12-15T14:30:00Z"
            },
            {
                "id": "uuid2",
                "name": "old-service",
                "key_prefix": "sk_live_yyyyy",
                "permissions": ["read"],
                "expires_at": "2024-12-15T10:00:00Z",
                "is_active": false,
                "is_revoked": false,
                "is_expired": true,
                "created_at": "2024-11-15T10:00:00Z",
                "last_used_at": "2024-12-10T14:30:00Z"
            }
        ],
        "total": 2,
        "active_count": 1
    }
}
```

**Note:** Expired keys are automatically marked as `is_active=false` when:
1. The key is used for authentication and found to be expired
2. This endpoint is called (proactive cleanup)

Expired keys can be revoked to free up the 5-key limit or use the rollover endpoint to create a new key with the same permissions.

---

#### DELETE /keys/{key_id}
Revoke an API key. Once revoked, the key can no longer be used for authentication.

**Authentication:** JWT only

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "API key revoked successfully",
    "data": null
}
```

**Notes:**
- Revoked keys are marked `is_revoked=true` and `is_active=false`
- Revoking a key frees up a slot in your 5-key limit
- Revoked keys still appear in list but cannot be used
- Action is immediate and irreversible

---

### Wallet Operations

#### POST /wallet/deposit
Initiate a deposit via Paystack.

**Authentication:** JWT or API key with `deposit` permission

**Request Body:**
```json
{
    "amount": 5000
}
```

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Deposit initiated",
    "data": {
        "reference": "DEP_1234567890_ABCD1234",
        "authorization_url": "https://paystack.co/checkout/..."
    }
}
```

**Flow:**
1. Call this endpoint with amount
2. Redirect user to `authorization_url`
3. User completes payment on Paystack
4. Paystack sends webhook to credit wallet

---

#### POST /wallet/paystack/webhook
Paystack webhook endpoint (called by Paystack, not users).

**Headers:**
| Header | Required | Description |
|--------|----------|-------------|
| x-paystack-signature | Yes | HMAC signature from Paystack |

**Response:**
```json
{
    "status": true
}
```

---

#### GET /wallet/deposit/{reference}/status
Check deposit transaction status.

**Authentication:** JWT or API key with `read` permission

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Transaction status retrieved",
    "data": {
        "reference": "DEP_1234567890_ABCD1234",
        "status": "success|failed|pending",
        "amount": 5000
    }
}
```

⚠️ **Warning:** This endpoint does NOT credit wallets. Only the webhook credits wallets.

---

#### GET /wallet/balance
Get wallet balance.

**Authentication:** JWT or API key with `read` permission

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Balance retrieved",
    "data": {
        "balance": 15000
    }
}
```

---

#### POST /wallet/transfer
Transfer funds to another wallet.

**Authentication:** JWT or API key with `transfer` permission

**Request Body:**
```json
{
    "wallet_number": "4566678954356",
    "amount": 3000
}
```

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Transfer completed",
    "data": {
        "reference": "TRF_1234567890_ABCD1234_OUT",
        "amount": 3000,
        "recipient_wallet": "4566678954356"
    }
}
```

**Validations:**
- Sender must have sufficient balance
- Recipient wallet must exist
- Cannot transfer to own wallet

---

#### GET /wallet/transactions
Get transaction history.

**Authentication:** JWT or API key with `read` permission

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| limit | int | 50 | Maximum transactions to return |
| offset | int | 0 | Pagination offset |

**Response:**
```json
{
    "status_code": 200,
    "status": "success",
    "message": "Transactions retrieved",
    "data": [
        {
            "type": "deposit",
            "amount": 5000,
            "status": "success",
            "reference": "DEP_1234567890_ABCD1234",
            "description": "Deposit of ₦5,000.00",
            "created_at": "2024-12-15T10:00:00Z"
        },
        {
            "type": "transfer_out",
            "amount": 3000,
            "status": "success",
            "reference": "TRF_1234567890_ABCD1234_OUT",
            "description": "Transfer to wallet 4566678954356",
            "created_at": "2024-12-15T11:00:00Z"
        }
    ]
}
```

---

## API Key Authentication

### How API Keys Work

1. **Key Format:** `sk_live_XXXXXXXXXXX` (15-20 characters)
2. **Header:** `x-api-key: sk_live_XXXXXXXXXXX`
3. **Database Storage:** Hashed using bcrypt for security
4. **Prefix Display:** Only first 8 characters shown in list endpoint
5. **Shown Once:** Full key only displayed when created

### Key Lifecycle

```
Created → Active → Expires/Revoked → Inactive → Can be rolled over/deleted
```

### Permissions

Each key has one or more of these permissions:

| Permission | Allows |
|-----------|--------|
| `read` | GET /wallet/balance, GET /wallet/transactions, GET /wallet/deposit/{ref}/status |
| `deposit` | POST /wallet/deposit (Paystack deposits) |
| `transfer` | POST /wallet/transfer (send money to other wallets) |

### Automatic Expiry Handling

When a key expires:
1. **On Authentication:** If expired key is used, it's immediately marked `is_active=false`
2. **On List:** Expired keys are automatically marked inactive when listing keys
3. **In Response:** Expired keys show `is_expired=true` and `is_active=false`
4. **Rejection:** Expired keys cannot be used for any operations
5. **Can Rollover:** Use rollover endpoint to create new key with same permissions

---

All errors follow this structure:

```json
{
    "status_code": 400,
    "status": "error",
    "message": "Error description",
    "data": null
}
```

### Common Error Codes

| Code | Description | Example |
|------|-------------|---------|
| 400 | Bad Request - Invalid input | Invalid wallet number format |
| 401 | Unauthorized - Invalid/missing auth | Missing Authorization header or invalid token |
| 403 | Forbidden - Missing required permissions | Using read-only key for transfer |
| 404 | Not Found - Resource doesn't exist | Wallet number doesn't exist |
| 422 | Unprocessable Entity - Validation error | Insufficient balance for transfer |
| 500 | Internal Server Error | Database connection failed |

---

## Quick Start

### 1. Authenticate with Google OAuth
```bash
# Get Google OAuth URL (returns JSON)
curl "http://localhost:8000/api/v1/auth/google?redirect=false"

# Response includes google_auth_url - visit that URL in browser
# After signing in, you'll get a callback with JWT token
```

### 2. Create API Key
```bash
# Create a key with deposit and read permissions, expires in 1 day
curl -X POST http://localhost:8000/api/v1/keys/create \
  -H "Authorization: Bearer <your_jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "my-service",
    "permissions": ["deposit", "read"],
    "expiry": "1D"
  }'

# Response includes full API key (shown only once!)
# Store it securely
```

### 3. List Your API Keys
```bash
# See all your keys and their status
curl http://localhost:8000/api/v1/keys/list \
  -H "Authorization: Bearer <your_jwt_token>"

# Shows: active_count, total, is_expired status for each key
```

### 4. Check Balance (with API Key)
```bash
# Use the API key from step 2 (must have 'read' permission)
curl http://localhost:8000/api/v1/wallet/balance \
  -H "x-api-key: sk_live_xxxxx"
```

### 5. Make Deposit
```bash
# Initiate Paystack deposit
curl -X POST http://localhost:8000/api/v1/wallet/deposit \
  -H "Authorization: Bearer <your_jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{"amount": 5000}'

# Response includes:
# - reference: Store for status checking
# - authorization_url: Redirect user here to complete payment
```

### 6. Transfer Funds
```bash
# Send money to another user's wallet
curl -X POST http://localhost:8000/api/v1/wallet/transfer \
  -H "Authorization: Bearer <your_jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "wallet_number": "1234567890123",
    "amount": 1000
  }'

# Requires:
# - 'transfer' permission (if using API key)
# - Sufficient balance
# - Valid recipient wallet
```

### 7. Rollover Expired Key
```bash
# Create new key with same permissions as expired key
curl -X POST http://localhost:8000/api/v1/keys/rollover \
  -H "Authorization: Bearer <your_jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "expired_key_id": "FGH2485K6KK79GKG9GKGK",
    "expiry": "1M"
  }'
```

### 8. Revoke API Key
```bash
# Permanently disable a key
curl -X DELETE http://localhost:8000/api/v1/keys/{key_id} \
  -H "Authorization: Bearer <your_jwt_token>"

# This frees up a slot in your 5-key limit
```
